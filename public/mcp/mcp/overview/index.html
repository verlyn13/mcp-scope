<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>MCP Architecture Overview | ScopeCam MCP Documentation</title>
<meta name=description content="Documentation for the ScopeCam Multi-Agent Control Platform"><style>body{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,Helvetica,Arial,sans-serif;line-height:1.6;color:#333;max-width:1200px;margin:0 auto;padding:0 20px}.header{padding:20px 0;border-bottom:1px solid #eee}.layer-switch{display:flex;margin:10px 0}.layer-button{padding:8px 16px;background:#f1f1f1;border:1px solid #ddd;cursor:pointer}.layer-button.active{background:#007bff;color:#fff}.sidebar{width:250px;float:left;padding-right:30px}.main-content{margin-left:280px}.status{display:inline-block;padding:5px;border-radius:3px;margin-bottom:20px}.status-active{background-color:#d4edda;color:#155724}.status-draft{background-color:#fff3cd;color:#856404}.status-review{background-color:#ffe5d0;color:#ff8000}.status-outdated{background-color:#f8d7da;color:#721c24}.status-archived{background-color:#e2e3e5;color:#383d41}.footer{margin-top:50px;padding:20px 0;border-top:1px solid #eee;font-size:.9em}pre{background:#f8f9fa;padding:15px;border-radius:4px;overflow:auto}code{font-family:SFMono-Regular,Consolas,liberation mono,Menlo,monospace;background:#f8f9fa;padding:2px 4px;border-radius:3px}@media(max-width:768px){.sidebar{float:none;width:100%}.main-content{margin-left:0}}</style></head><body><header class=header><div class=container><a href=https://example.github.io/mcp-scope/ class=logo>ScopeCam MCP Documentation</a><div class=layer-switch><button class=layer-button data-layer=root>
Root Documentation
</button>
<button class=layer-button data-layer=mcp>
MCP Documentation</button></div><nav class=main-nav><ul><li><a href=/mcp-scope/>Home</a></li><li><a href=/mcp-scope/project/>Project</a></li><li><a href=/mcp-scope/architecture/>Architecture</a></li><li><a href=/mcp-scope/guides/>Guides</a></li><li><a href=/mcp-scope/standards/>Standards</a></li><li><a href=/mcp-scope/mcp/>MCP</a></li></ul></nav></div></header><div class=container><aside class=sidebar><nav class=sidebar-nav><div class=section-navigation><h3>Mcp</h3><ul><li><a href=https://example.github.io/mcp-scope/mcp/mcp/containerized-development-guide/></a></li><li><a href=https://example.github.io/mcp-scope/mcp/mcp/contributing/></a></li><li><a href=https://example.github.io/mcp-scope/mcp/mcp/environment-setup/></a></li><li><a href=https://example.github.io/mcp-scope/mcp/mcp/getting-started/></a></li><li><a href=https://example.github.io/mcp-scope/mcp/mcp/local-development-guide/></a></li><li><a href=https://example.github.io/mcp-scope/mcp/mcp/first-steps/>Getting Started with MCP</a></li><li><a href=https://example.github.io/mcp-scope/mcp/mcp/overview/ class=active>MCP Architecture Overview</a></li><li><a href=https://example.github.io/mcp-scope/mcp/mcp/containerized-development-guide/>MCP Containerized Development Guide</a></li><li><a href=https://example.github.io/mcp-scope/mcp/mcp/project-setup/>MCP Development Environment Setup</a></li><li><a href=https://example.github.io/mcp-scope/mcp/mcp/readme/>MCP Documentation Index</a></li><li><a href=https://example.github.io/mcp-scope/mcp/mcp/local-development-guide/>MCP Local Development Guide</a></li><li><a href=https://example.github.io/mcp-scope/mcp/>Mcps</a></li></ul><p><a href=/>&larr; Back to home</a></p></div></nav></aside><main class=main-content><article class=content><header><h1>MCP Architecture Overview</h1><div class="status status-active">🟢 Active</div><div class=metadata><span class=created-date>Created: 2025-03-22</span>
<span class=updated-date>Updated: 2025-03-22</span>
<span class=version>Version: 1.0</span><div class=contributors>Contributors:
Documentation Architect</div></div></header><div class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#system-architecture>System Architecture</a><ul><li><a href=#key-components>Key Components</a></li></ul></li><li><a href=#message-flow>Message Flow</a><ul><li><a href=#agent-registration-flow>Agent Registration Flow</a></li><li><a href=#task-distribution-flow>Task Distribution Flow</a></li><li><a href=#health-monitoring-flow>Health Monitoring Flow</a></li></ul></li><li><a href=#agent-state-machine>Agent State Machine</a></li><li><a href=#core-data-models>Core Data Models</a><ul><li><a href=#agent-management>Agent Management</a></li><li><a href=#task-processing>Task Processing</a></li></ul></li><li><a href=#communication-protocols>Communication Protocols</a><ul><li><a href=#nats-topic-structure>NATS Topic Structure</a></li><li><a href=#message-formats>Message Formats</a></li></ul></li><li><a href=#design-principles>Design Principles</a><ul><li><a href=#1-loose-coupling>1. Loose Coupling</a></li><li><a href=#2-single-responsibility>2. Single Responsibility</a></li><li><a href=#3-resilience>3. Resilience</a></li><li><a href=#4-extensibility>4. Extensibility</a></li><li><a href=#5-observability>5. Observability</a></li></ul></li><li><a href=#security-considerations>Security Considerations</a></li><li><a href=#scalability-considerations>Scalability Considerations</a></li><li><a href=#future-architectural-enhancements>Future Architectural Enhancements</a></li><li><a href=#known-limitations>Known Limitations</a></li><li><a href=#related-documents>Related Documents</a></li><li><a href=#changelog>Changelog</a></li></ul></nav></div><div class=content-body><h1 id=mcp-architecture-overview>MCP Architecture Overview</h1><p>🟢 <strong>Active</strong></p><p><a href=/docs/README.md>↩️ Back to Documentation Index</a></p><h2 id=overview>Overview</h2><p>This document provides a comprehensive overview of the Multi-Agent Control Platform (MCP) architecture, explaining the core components, their interactions, and the underlying design principles.</p><h2 id=system-architecture>System Architecture</h2><p>The MCP system follows a message-driven, distributed architecture built around a central orchestrator and specialized agents:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>┌─────────────────────┐
</span></span><span style=display:flex><span>│                     │
</span></span><span style=display:flex><span>│ Android Application │
</span></span><span style=display:flex><span>│                     │
</span></span><span style=display:flex><span>└─────────┬───────────┘
</span></span><span style=display:flex><span>           │ HTTP/WebSocket
</span></span><span style=display:flex><span>           ▼
</span></span><span style=display:flex><span>┌─────────────────────┐
</span></span><span style=display:flex><span>│   MCP Orchestrator  │◄────┐
</span></span><span style=display:flex><span>│  ┌───────────────┐  │     │
</span></span><span style=display:flex><span>│  │   FSM Engine  │  │     │ Agent
</span></span><span style=display:flex><span>│  └───────────────┘  │     │ Registration
</span></span><span style=display:flex><span>└─────────┬───────────┘     │
</span></span><span style=display:flex><span>           │ NATS            │
</span></span><span style=display:flex><span>           ▼                 │
</span></span><span style=display:flex><span>┌─────────────────────┐     │
</span></span><span style=display:flex><span>│   Agent Framework   │─────┘
</span></span><span style=display:flex><span>│  ┌───────┐ ┌──────┐ │
</span></span><span style=display:flex><span>│  │Agent 1│ │Agent2│ │
</span></span><span style=display:flex><span>│  └───────┘ └──────┘ │
</span></span><span style=display:flex><span>└─────────────────────┘
</span></span></code></pre></td></tr></table></div></div><h3 id=key-components>Key Components</h3><ol><li><p><strong>MCP Orchestrator</strong></p><ul><li>Central coordination component</li><li>Manages agent lifecycle and registration</li><li>Distributes tasks to appropriate agents</li><li>Monitors system health</li></ul></li><li><p><strong>Agent Framework</strong></p><ul><li>Provides common interface for all agents</li><li>Implements state machine for agent lifecycle</li><li>Handles communication with orchestrator</li><li>Enables consistent behavior across different agent types</li></ul></li><li><p><strong>NATS Messaging System</strong></p><ul><li>High-performance message broker</li><li>Enables asynchronous communication between components</li><li>Supports various messaging patterns (request-reply, pub-sub, queue groups)</li><li>Provides reliable message delivery</li></ul></li><li><p><strong>Specialized Agents</strong></p><ul><li>Camera Integration Agent: Handles USB camera detection and operations</li><li>Python Processor Agent: Provides data processing capabilities</li><li>Future agents: Build system, testing, code generation, etc.</li></ul></li><li><p><strong>Client Applications</strong></p><ul><li>Android applications that consume MCP services</li><li>Web interfaces for system monitoring and control</li><li>Command-line tools for development and testing</li></ul></li></ol><h2 id=message-flow>Message Flow</h2><p>The system uses message-driven communication with the following patterns:</p><h3 id=agent-registration-flow>Agent Registration Flow</h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>┌─────────┐                 ┌───────────┐                ┌──────┐
</span></span><span style=display:flex><span>│ Agent   │                 │Orchestrator│                │ NATS │
</span></span><span style=display:flex><span>└────┬────┘                 └─────┬─────┘                └───┬──┘
</span></span><span style=display:flex><span>     │                            │                          │
</span></span><span style=display:flex><span>     │ Initialize                 │                          │
</span></span><span style=display:flex><span>     │────────────────────────────────────────────────────►│
</span></span><span style=display:flex><span>     │                            │                          │
</span></span><span style=display:flex><span>     │                            │ Subscribe to             │
</span></span><span style=display:flex><span>     │                            │ mcp.agent.register       │
</span></span><span style=display:flex><span>     │                            │◄─────────────────────────│
</span></span><span style=display:flex><span>     │                            │                          │
</span></span><span style=display:flex><span>     │ Publish to                 │                          │
</span></span><span style=display:flex><span>     │ mcp.agent.register         │                          │
</span></span><span style=display:flex><span>     │────────────────────────────────────────────────────►│
</span></span><span style=display:flex><span>     │                            │                          │
</span></span><span style=display:flex><span>     │                            │ Receive registration     │
</span></span><span style=display:flex><span>     │                            │◄─────────────────────────│
</span></span><span style=display:flex><span>     │                            │                          │
</span></span><span style=display:flex><span>     │                            │ Add agent to registry    │
</span></span><span style=display:flex><span>     │                            │─────┐                    │
</span></span><span style=display:flex><span>     │                            │     │                    │
</span></span><span style=display:flex><span>     │                            │◄────┘                    │
</span></span></code></pre></td></tr></table></div></div><h3 id=task-distribution-flow>Task Distribution Flow</h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>┌─────────┐                 ┌───────────┐                ┌──────┐                ┌──────┐
</span></span><span style=display:flex><span>│ Client  │                 │Orchestrator│                │ NATS │                │ Agent│
</span></span><span style=display:flex><span>└────┬────┘                 └─────┬─────┘                └───┬──┘                └───┬──┘
</span></span><span style=display:flex><span>     │                            │                          │                       │
</span></span><span style=display:flex><span>     │ Submit task                │                          │                       │
</span></span><span style=display:flex><span>     │ (HTTP or NATS)             │                          │                       │
</span></span><span style=display:flex><span>     │───────────────────────────►│                          │                       │
</span></span><span style=display:flex><span>     │                            │                          │                       │
</span></span><span style=display:flex><span>     │                            │ Find suitable agent      │                       │
</span></span><span style=display:flex><span>     │                            │─────┐                    │                       │
</span></span><span style=display:flex><span>     │                            │     │                    │                       │
</span></span><span style=display:flex><span>     │                            │◄────┘                    │                       │
</span></span><span style=display:flex><span>     │                            │                          │                       │
</span></span><span style=display:flex><span>     │                            │ Publish to               │                       │
</span></span><span style=display:flex><span>     │                            │ mcp.task.{agentId}       │                       │
</span></span><span style=display:flex><span>     │                            │─────────────────────────►│                       │
</span></span><span style=display:flex><span>     │                            │                          │                       │
</span></span><span style=display:flex><span>     │                            │                          │ Deliver task          │
</span></span><span style=display:flex><span>     │                            │                          │──────────────────────►│
</span></span><span style=display:flex><span>     │                            │                          │                       │
</span></span><span style=display:flex><span>     │                            │                          │                       │ Process
</span></span><span style=display:flex><span>     │                            │                          │                       │ task
</span></span><span style=display:flex><span>     │                            │                          │                       │─────┐
</span></span><span style=display:flex><span>     │                            │                          │                       │     │
</span></span><span style=display:flex><span>     │                            │                          │                       │◄────┘
</span></span><span style=display:flex><span>     │                            │                          │                       │
</span></span><span style=display:flex><span>     │                            │                          │ Publish result to     │
</span></span><span style=display:flex><span>     │                            │                          │ mcp.task.{id}.result  │
</span></span><span style=display:flex><span>     │                            │                          │◄─────────────────────│
</span></span><span style=display:flex><span>     │                            │                          │                       │
</span></span><span style=display:flex><span>     │                            │ Receive result           │                       │
</span></span><span style=display:flex><span>     │                            │◄─────────────────────────│                       │
</span></span><span style=display:flex><span>     │                            │                          │                       │
</span></span><span style=display:flex><span>     │ Return result              │                          │                       │
</span></span><span style=display:flex><span>     │◄───────────────────────────│                          │                       │
</span></span></code></pre></td></tr></table></div></div><h3 id=health-monitoring-flow>Health Monitoring Flow</h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>┌──────────┐              ┌───────────┐               ┌──────┐               ┌──────┐
</span></span><span style=display:flex><span>│ Monitor  │              │Orchestrator│               │ NATS │               │ Agent│
</span></span><span style=display:flex><span>└────┬─────┘              └─────┬─────┘               └───┬──┘               └───┬──┘
</span></span><span style=display:flex><span>     │                          │                         │                      │
</span></span><span style=display:flex><span>     │                          │                         │ Publish heartbeat    │
</span></span><span style=display:flex><span>     │                          │                         │ mcp.agent.heartbeat  │
</span></span><span style=display:flex><span>     │                          │                         │◄─────────────────────│
</span></span><span style=display:flex><span>     │                          │                         │                      │
</span></span><span style=display:flex><span>     │                          │ Receive heartbeat       │                      │
</span></span><span style=display:flex><span>     │                          │◄────────────────────────│                      │
</span></span><span style=display:flex><span>     │                          │                         │                      │
</span></span><span style=display:flex><span>     │                          │ Update agent status     │                      │
</span></span><span style=display:flex><span>     │                          │──────┐                  │                      │
</span></span><span style=display:flex><span>     │                          │      │                  │                      │
</span></span><span style=display:flex><span>     │                          │◄─────┘                  │                      │
</span></span><span style=display:flex><span>     │                          │                         │                      │
</span></span><span style=display:flex><span>     │ Request system status    │                         │                      │
</span></span><span style=display:flex><span>     │─────────────────────────►│                         │                      │
</span></span><span style=display:flex><span>     │                          │                         │                      │
</span></span><span style=display:flex><span>     │ Return system status     │                         │                      │
</span></span><span style=display:flex><span>     │◄─────────────────────────│                         │                      │
</span></span><span style=display:flex><span>     │                          │                         │                      │
</span></span></code></pre></td></tr></table></div></div><h2 id=agent-state-machine>Agent State Machine</h2><p>The agent lifecycle is governed by a finite state machine with the following states and transitions:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>┌─────────┐
</span></span><span style=display:flex><span>│         │
</span></span><span style=display:flex><span>│  Idle   │◄────────────────┐
</span></span><span style=display:flex><span>│         │                 │
</span></span><span style=display:flex><span>└────┬────┘                 │
</span></span><span style=display:flex><span>     │                      │
</span></span><span style=display:flex><span>     │ Initialize           │
</span></span><span style=display:flex><span>     ▼                      │
</span></span><span style=display:flex><span>┌─────────┐          ┌──────────┐
</span></span><span style=display:flex><span>│         │          │          │
</span></span><span style=display:flex><span>│ Initial-│──Error──►│  Error   │
</span></span><span style=display:flex><span>│  izing  │          │          │
</span></span><span style=display:flex><span>│         │          └──────┬───┘
</span></span><span style=display:flex><span>└────┬────┘                 │
</span></span><span style=display:flex><span>     │                      │
</span></span><span style=display:flex><span>     │ Process              │ Initialize
</span></span><span style=display:flex><span>     ▼                      │
</span></span><span style=display:flex><span>┌─────────┐                 │
</span></span><span style=display:flex><span>│         │                 │
</span></span><span style=display:flex><span>│ Process-│─────────────────┘
</span></span><span style=display:flex><span>│   ing   │
</span></span><span style=display:flex><span>│         │
</span></span><span style=display:flex><span>└────┬────┘
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     │ Shutdown
</span></span><span style=display:flex><span>     ▼
</span></span><span style=display:flex><span>┌─────────┐
</span></span><span style=display:flex><span>│ Shutting│
</span></span><span style=display:flex><span>│  Down   │
</span></span><span style=display:flex><span>│         │
</span></span><span style=display:flex><span>└─────────┘
</span></span></code></pre></td></tr></table></div></div><h2 id=core-data-models>Core Data Models</h2><h3 id=agent-management>Agent Management</h3><ul><li><strong>AgentState</strong>: Sealed class representing the different states in the agent lifecycle</li><li><strong>AgentEvent</strong>: Sealed class for events that trigger state transitions</li><li><strong>AgentStatus</strong>: Data class containing the current status of an agent</li><li><strong>McpAgent</strong>: Interface that all agents must implement</li></ul><h3 id=task-processing>Task Processing</h3><ul><li><strong>AgentTask</strong>: Data class representing a task to be executed by an agent</li><li><strong>TaskResult</strong>: Data class containing the result of a task execution</li><li><strong>TaskStatus</strong>: Enum representing the different states of a task</li></ul><h2 id=communication-protocols>Communication Protocols</h2><h3 id=nats-topic-structure>NATS Topic Structure</h3><ul><li><code>mcp.agent.register</code>: Agent registration</li><li><code>mcp.agent.heartbeat</code>: Agent heartbeat messages</li><li><code>mcp.task.submit</code>: Task submission</li><li><code>mcp.task.{taskId}.status</code>: Task status updates</li><li><code>mcp.task.{taskId}.result</code>: Task results</li><li><code>mcp.system.health</code>: System health monitoring</li></ul><h3 id=message-formats>Message Formats</h3><p>All messages are serialized using JSON (via Kotlin Serialization in JVM components and standard libraries in Python components).</p><h2 id=design-principles>Design Principles</h2><h3 id=1-loose-coupling>1. Loose Coupling</h3><p>Components communicate exclusively through messages, with no direct dependencies between agents or between agents and the orchestrator.</p><h3 id=2-single-responsibility>2. Single Responsibility</h3><p>Each component has a clear, well-defined responsibility:</p><ul><li>Orchestrator: Task distribution and agent management</li><li>Agents: Specialized domain-specific operations</li><li>NATS: Message delivery and routing</li></ul><h3 id=3-resilience>3. Resilience</h3><p>The system is designed to be resilient to failures:</p><ul><li>Stateless communication</li><li>Automatic reconnection to NATS</li><li>Exponential backoff for retries</li><li>Circuit breakers for failing components</li></ul><h3 id=4-extensibility>4. Extensibility</h3><p>New agents can be added without modifying existing components, as long as they implement the McpAgent interface and follow the messaging protocols.</p><h3 id=5-observability>5. Observability</h3><p>The system provides comprehensive monitoring and logging:</p><ul><li>Agent heartbeats for health monitoring</li><li>Detailed task status tracking</li><li>Structured logging</li></ul><h2 id=security-considerations>Security Considerations</h2><p>The current implementation focuses on functionality rather than security. In a production environment, consider:</p><ol><li><p><strong>Authentication and Authorization</strong>:</p><ul><li>Secure access to NATS with username/password or certificates</li><li>Implement fine-grained access control for topics</li></ul></li><li><p><strong>Network Security</strong>:</p><ul><li>Use TLS for all communications</li><li>Implement network segmentation</li></ul></li><li><p><strong>Data Protection</strong>:</p><ul><li>Encrypt sensitive data in messages</li><li>Implement secure storage for credentials</li></ul></li></ol><h2 id=scalability-considerations>Scalability Considerations</h2><p>The architecture supports horizontal scaling through:</p><ol><li><p><strong>Agent Replication</strong>:</p><ul><li>Multiple instances of the same agent type can run simultaneously</li><li>NATS queue groups ensure each task is processed only once</li></ul></li><li><p><strong>NATS Clustering</strong>:</p><ul><li>NATS can be configured as a cluster for higher throughput</li><li>NATS superclusters can span multiple regions</li></ul></li><li><p><strong>Orchestrator Statelessness</strong>:</p><ul><li>The orchestrator can be scaled horizontally by using a shared database for agent registrations</li></ul></li></ol><h2 id=future-architectural-enhancements>Future Architectural Enhancements</h2><p>Potential future enhancements to the architecture include:</p><ol><li><strong>Task Scheduling</strong>: Add priority-based scheduling and task dependencies</li><li><strong>Agent Discovery</strong>: Dynamic discovery of agents across networks</li><li><strong>Distributed Tracing</strong>: Add tracing for end-to-end visibility of task processing</li><li><strong>Reactive Execution Model</strong>: Move to a fully reactive execution model with backpressure support</li><li><strong>Multi-Tenancy</strong>: Support for multiple isolated environments within the same infrastructure</li></ol><h2 id=known-limitations>Known Limitations</h2><ul><li>No built-in authentication or authorization mechanism</li><li>Limited error handling for complex failure scenarios</li><li>No persistent storage for task history</li><li>No built-in metrics collection for performance monitoring</li></ul><h2 id=related-documents>Related Documents</h2><ul><li><a href=/docs/architecture/fsm-agent-interfaces.md>FSM and Agent Interfaces</a></li><li><a href=/docs/architecture/orchestrator-nats-integration.md>Orchestrator and NATS Integration</a></li><li><a href=/docs/architecture/camera-integration-agent.md>Camera Integration Agent</a></li><li><a href=/docs/architecture/health-monitoring-framework.md>Health Monitoring Framework</a></li></ul><h2 id=changelog>Changelog</h2><ul><li>1.0.0 (2025-03-22): Initial release</li></ul></div><div class=related-docs><h2>Related Documents</h2><ul><li><a href=/docs/README.md>/docs/README.md</a></li><li><a href=/docs/project/first-steps.md>/docs/project/first-steps.md</a></li><li><a href=/docs/architecture/fsm-agent-interfaces.md>/docs/architecture/fsm-agent-interfaces.md</a></li><li><a href=/docs/architecture/orchestrator-nats-integration.md>/docs/architecture/orchestrator-nats-integration.md</a></li></ul></div><div class=tags><h3>Tags</h3><ul><li><a href=/tags/architecture>architecture</a></li><li><a href=/tags/design>design</a></li><li><a href=/tags/message-driven>message-driven</a></li><li><a href=/tags/state-machine>state-machine</a></li></ul></div></article></main></div><footer class=footer><div class=container><p>&copy; 2025 ScopeCam MCP Documentation. All rights reserved.</p></div></footer></body></html>