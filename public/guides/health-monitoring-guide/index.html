<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>MCP Health Monitoring Guide | ScopeCam MCP Documentation</title>
<meta name=description content="Documentation for the ScopeCam Multi-Agent Control Platform"><style>body{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,Helvetica,Arial,sans-serif;line-height:1.6;color:#333;max-width:1200px;margin:0 auto;padding:0 20px}.header{padding:20px 0;border-bottom:1px solid #eee}.layer-switch{display:flex;margin:10px 0}.layer-button{padding:8px 16px;background:#f1f1f1;border:1px solid #ddd;cursor:pointer}.layer-button.active{background:#007bff;color:#fff}.sidebar{width:250px;float:left;padding-right:30px}.main-content{margin-left:280px}.status{display:inline-block;padding:5px;border-radius:3px;margin-bottom:20px}.status-active{background-color:#d4edda;color:#155724}.status-draft{background-color:#fff3cd;color:#856404}.status-review{background-color:#ffe5d0;color:#ff8000}.status-outdated{background-color:#f8d7da;color:#721c24}.status-archived{background-color:#e2e3e5;color:#383d41}.footer{margin-top:50px;padding:20px 0;border-top:1px solid #eee;font-size:.9em}pre{background:#f8f9fa;padding:15px;border-radius:4px;overflow:auto}code{font-family:SFMono-Regular,Consolas,liberation mono,Menlo,monospace;background:#f8f9fa;padding:2px 4px;border-radius:3px}@media(max-width:768px){.sidebar{float:none;width:100%}.main-content{margin-left:0}}</style></head><body><header class=header><div class=container><a href=https://example.github.io/mcp-scope/ class=logo>ScopeCam MCP Documentation</a><div class=layer-switch><button class=layer-button data-layer=root>
Root Documentation
</button>
<button class=layer-button data-layer=mcp>
MCP Documentation</button></div><nav class=main-nav><ul><li><a href=/mcp-scope/>Home</a></li><li><a href=/mcp-scope/project/>Project</a></li><li><a href=/mcp-scope/architecture/>Architecture</a></li><li><a href=/mcp-scope/guides/>Guides</a></li><li><a href=/mcp-scope/standards/>Standards</a></li><li><a href=/mcp-scope/mcp/>MCP</a></li></ul></nav></div></header><div class=container><aside class=sidebar><nav class=sidebar-nav><div class=section-navigation><h3>Guides</h3><ul><li><a href=https://example.github.io/mcp-scope/guides/build-engineer-implementation-guide/></a></li><li><a href=https://example.github.io/mcp-scope/guides/build-engineer-onboarding-checklist/></a></li><li><a href=https://example.github.io/mcp-scope/guides/build-engineer-quick-start/></a></li><li><a href=https://example.github.io/mcp-scope/guides/build-engineer-tech-specs/></a></li><li><a href=https://example.github.io/mcp-scope/guides/>Guides</a></li><li><a href=https://example.github.io/mcp-scope/guides/containerized-dev-environment/>MCP Containerized Development Environment</a></li><li><a href=https://example.github.io/mcp-scope/guides/health-monitoring-guide/ class=active>MCP Health Monitoring Guide</a></li><li><a href=https://example.github.io/mcp-scope/guides/testing-guide/>MCP Testing Guide</a></li></ul><p><a href=/>&larr; Back to home</a></p></div></nav></aside><main class=main-content><article class=content><header><h1>MCP Health Monitoring Guide</h1><div class="status status-active">üü¢ Active</div><div class=metadata><span class=created-date>Created: 2025-03-23</span>
<span class=updated-date>Updated: 2025-03-23</span>
<span class=version>Version: 1.0</span><div class=contributors>Contributors:
Documentation Architect
, Build Engineer</div></div></header><div class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#health-monitoring-components>Health Monitoring Components</a><ul><li><a href=#system-architecture>System Architecture</a></li></ul></li><li><a href=#metrics-collection>Metrics Collection</a><ul><li><a href=#cpu-metrics>CPU Metrics</a></li><li><a href=#memory-metrics>Memory Metrics</a></li><li><a href=#thread-metrics>Thread Metrics</a></li><li><a href=#garbage-collection-metrics>Garbage Collection Metrics</a></li><li><a href=#usage-example>Usage Example</a></li></ul></li><li><a href=#health-check-service>Health Check Service</a><ul><li><a href=#features>Features</a></li><li><a href=#health-status-levels>Health Status Levels</a></li><li><a href=#usage-example-1>Usage Example</a></li></ul></li><li><a href=#health-check-endpoints>Health Check Endpoints</a><ul><li><a href=#system-health>System Health</a></li><li><a href=#agent-health>Agent Health</a></li><li><a href=#orchestrator-status>Orchestrator Status</a></li><li><a href=#agent-listing>Agent Listing</a></li><li><a href=#query-example>Query Example</a></li></ul></li><li><a href=#circuit-breaker-pattern>Circuit Breaker Pattern</a><ul><li><a href=#states>States</a></li><li><a href=#configuration>Configuration</a></li><li><a href=#implementation-details>Implementation Details</a></li></ul></li><li><a href=#agent-state-monitoring>Agent State Monitoring</a><ul><li><a href=#state-transitions>State Transitions</a></li><li><a href=#state-change-listeners>State Change Listeners</a></li></ul></li><li><a href=#health-visualization>Health Visualization</a><ul><li><a href=#nats-cli-visualization>NATS CLI Visualization</a></li></ul></li><li><a href=#setting-up-health-monitoring>Setting Up Health Monitoring</a><ul><li><a href=#main-application-setup>Main Application Setup</a></li></ul></li><li><a href=#best-practices>Best Practices</a><ul><li><a href=#monitoring-frequency>Monitoring Frequency</a></li><li><a href=#alert-thresholds>Alert Thresholds</a></li><li><a href=#health-status-interpretation>Health Status Interpretation</a></li><li><a href=#resource-management>Resource Management</a></li></ul></li><li><a href=#troubleshooting>Troubleshooting</a><ul><li><a href=#common-issues>Common Issues</a></li></ul></li><li><a href=#future-enhancements>Future Enhancements</a></li><li><a href=#references>References</a></li></ul></nav></div><div class=content-body><h1 id=mcp-health-monitoring-guide>MCP Health Monitoring Guide</h1><p><a href=/docs/START_HERE.md>‚Ü©Ô∏è Back to Start Here</a> | <a href=/docs/README.md>‚Ü©Ô∏è Back to Documentation Index</a></p><h2 id=overview>Overview</h2><p>This guide documents the health monitoring system implemented for the Multi-Agent Control Platform (MCP). The health monitoring system provides real-time metrics collection, health status reporting, and resilience mechanisms to ensure system reliability and observability.</p><h2 id=health-monitoring-components>Health Monitoring Components</h2><h3 id=system-architecture>System Architecture</h3><p>The health monitoring system consists of the following components:</p><ol><li><strong>SystemMetricsCollector</strong>: Collects JVM and system-level metrics</li><li><strong>HealthCheckService</strong>: Provides health check endpoints and manages agent health status</li><li><strong>Circuit Breaker Pattern</strong>: Prevents cascading failures during outages</li><li><strong>Agent State Monitoring</strong>: Tracks agent state transitions for health assessment</li><li><strong>NATS Health Endpoints</strong>: For querying system and agent health status</li></ol><p><img src=../images/health-monitoring-architecture.png alt="Health Monitoring Architecture"></p><h2 id=metrics-collection>Metrics Collection</h2><p>The <code>SystemMetricsCollector</code> gathers various system and JVM metrics:</p><h3 id=cpu-metrics>CPU Metrics</h3><ul><li>Available processors</li><li>Process CPU load</li><li>System CPU load</li><li>System load average</li></ul><h3 id=memory-metrics>Memory Metrics</h3><ul><li>Total memory</li><li>Free memory</li><li>Used memory</li><li>Max memory</li><li>Heap utilization</li><li>Non-heap memory usage</li></ul><h3 id=thread-metrics>Thread Metrics</h3><ul><li>Active thread count</li><li>Peak thread count</li><li>Daemon thread count</li><li>Total started thread count</li></ul><h3 id=garbage-collection-metrics>Garbage Collection Metrics</h3><ul><li>GC collection count</li><li>GC collection time</li></ul><h3 id=usage-example>Usage Example</h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// Initialize the metrics collector
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> metricsCollector = SystemMetricsCollector()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Collect metrics
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> metrics = metricsCollector.collectMetrics()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Access specific metrics
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> cpuLoad = metrics.cpuMetrics.processCpuLoad
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> heapUsage = metrics.memoryMetrics.heapUtilizationPercent
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> threadCount = metrics.threadMetrics.threadCount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>println(<span style=color:#e6db74>&#34;CPU Load: </span><span style=color:#e6db74>$cpuLoad</span><span style=color:#e6db74>%, Heap Usage: </span><span style=color:#e6db74>$heapUsage</span><span style=color:#e6db74>%, Threads: </span><span style=color:#e6db74>$threadCount</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><h2 id=health-check-service>Health Check Service</h2><p>The <code>HealthCheckService</code> provides health check endpoints via NATS and manages agent health status tracking:</p><h3 id=features>Features</h3><ul><li>Periodic health status collection and publishing</li><li>Agent health status tracking</li><li>Circuit breaker pattern for failure handling</li><li>Health check endpoints via NATS</li></ul><h3 id=health-status-levels>Health Status Levels</h3><ul><li><code>HEALTHY</code>: Component is functioning normally</li><li><code>DEGRADED</code>: Component is functioning but with reduced capabilities</li><li><code>UNHEALTHY</code>: Component is not functioning correctly</li><li><code>STARTING</code>: Component is initializing</li><li><code>STOPPING</code>: Component is shutting down</li><li><code>UNKNOWN</code>: Component&rsquo;s status cannot be determined</li></ul><h3 id=usage-example-1>Usage Example</h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// Initialize the service
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> healthCheckService = HealthCheckService(
</span></span><span style=display:flex><span>    natsConnection = natsConnection,
</span></span><span style=display:flex><span>    metricsCollectionInterval = <span style=color:#ae81ff>15.</span>seconds
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Update agent health
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>healthCheckService.updateAgentHealth(agent, <span style=color:#a6e22e>AgentState</span>.Idle)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Get system health
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> systemHealth = healthCheckService.getSystemHealth()
</span></span><span style=display:flex><span>println(<span style=color:#e6db74>&#34;System status: </span><span style=color:#e6db74>${systemHealth.status}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>println(<span style=color:#e6db74>&#34;Agent count: </span><span style=color:#e6db74>${systemHealth.agentCount}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><h2 id=health-check-endpoints>Health Check Endpoints</h2><p>The health monitoring system exposes the following NATS endpoints:</p><h3 id=system-health>System Health</h3><ul><li>Subject: <code>mcp.health.system</code></li><li>Returns: Overall system health status, agent counts, metrics</li></ul><h3 id=agent-health>Agent Health</h3><ul><li>Subject: <code>mcp.health.agent</code></li><li>Message: Agent ID</li><li>Returns: Status of the specified agent, capabilities, last update</li></ul><h3 id=orchestrator-status>Orchestrator Status</h3><ul><li>Subject: <code>mcp.orchestrator.status</code></li><li>Returns: Orchestrator running status, agent count, timestamp</li></ul><h3 id=agent-listing>Agent Listing</h3><ul><li>Subject: <code>mcp.orchestrator.agents</code></li><li>Returns: List of registered agents with state and capabilities</li></ul><h3 id=query-example>Query Example</h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Using NATS CLI to query system health</span>
</span></span><span style=display:flex><span>nats req mcp.health.system <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Query specific agent health</span>
</span></span><span style=display:flex><span>nats req mcp.health.agent <span style=color:#e6db74>&#34;camera-agent-1&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=circuit-breaker-pattern>Circuit Breaker Pattern</h2><p>The health monitoring system implements the circuit breaker pattern to prevent cascading failures:</p><h3 id=states>States</h3><ol><li><strong>Closed</strong>: Normal operation, all requests processed</li><li><strong>Open</strong>: Failure threshold exceeded, requests fail fast</li><li><strong>Half-Open</strong>: Trial period after timeout, limited requests to test recovery</li></ol><h3 id=configuration>Configuration</h3><ul><li>Failure threshold: Number of consecutive failures before opening the circuit</li><li>Reset timeout: Time to wait before trying to close the circuit again</li></ul><h3 id=implementation-details>Implementation Details</h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// Health check service circuit breaker configuration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> healthCheckService = HealthCheckService(
</span></span><span style=display:flex><span>    natsConnection = natsConnection,
</span></span><span style=display:flex><span>    metricsCollectionInterval = <span style=color:#ae81ff>15.</span>seconds,
</span></span><span style=display:flex><span>    circuitBreakerThreshold = <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>    circuitBreakerResetTimeout = <span style=color:#ae81ff>30.</span>seconds
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><h2 id=agent-state-monitoring>Agent State Monitoring</h2><p>The system tracks agent state transitions to monitor health:</p><h3 id=state-transitions>State Transitions</h3><ul><li>Each agent has a state machine with well-defined states</li><li>State changes trigger health status updates</li><li>Unexpected transitions may indicate issues</li></ul><h3 id=state-change-listeners>State Change Listeners</h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// Add a state change listener to monitor transitions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>stateMachine.addStateChangeListener { oldState, newState <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>    println(<span style=color:#e6db74>&#34;Agent </span><span style=color:#e6db74>${agent.agentId}</span><span style=color:#e6db74> changed from </span><span style=color:#e6db74>$oldState</span><span style=color:#e6db74> to </span><span style=color:#e6db74>$newState</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Update health status based on new state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    healthCheckService.updateAgentHealth(agent, newState)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=health-visualization>Health Visualization</h2><p>The health monitoring data can be visualized using:</p><ol><li><strong>NATS CLI</strong>: For quick checks and debugging</li><li><strong>Prometheus/Grafana</strong>: For long-term monitoring (integration guide coming soon)</li><li><strong>Custom Dashboard</strong>: A simple web dashboard is planned</li></ol><h3 id=nats-cli-visualization>NATS CLI Visualization</h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Watch system health in real-time</span>
</span></span><span style=display:flex><span>nats sub <span style=color:#e6db74>&#34;mcp.health.metrics&#34;</span> --json
</span></span></code></pre></td></tr></table></div></div><h2 id=setting-up-health-monitoring>Setting Up Health Monitoring</h2><p>To set up the health monitoring system:</p><ol><li>Ensure the NATS server is running</li><li>Initialize the health monitoring components in the main application</li><li>Configure agents to report their status</li></ol><h3 id=main-application-setup>Main Application Setup</h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// In your Main.kt:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>main</span>() = runBlocking {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Connect to NATS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>val</span> natsManager = NatsConnectionManager()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> natsConnection = natsManager.connect()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Initialize health monitoring
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>val</span> metricsCollector = SystemMetricsCollector()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> healthCheckService = HealthCheckService(natsConnection)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Initialize orchestrator with health monitoring
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>val</span> orchestrator = Orchestrator(natsConnection)
</span></span><span style=display:flex><span>    orchestrator.start()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Keep application running
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>        delay(<span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=best-practices>Best Practices</h2><h3 id=monitoring-frequency>Monitoring Frequency</h3><ul><li>Balance between timely data and system overhead</li><li>15-30 second intervals for most metrics</li><li>1-5 minute intervals for less critical metrics</li></ul><h3 id=alert-thresholds>Alert Thresholds</h3><ul><li>CPU: Alert at 80% sustained utilization</li><li>Memory: Alert at 85% heap utilization</li><li>Threads: Alert on abnormal thread count increases</li><li>GC: Alert on high GC frequency or duration</li></ul><h3 id=health-status-interpretation>Health Status Interpretation</h3><ul><li><code>DEGRADED</code> status requires investigation but not immediate action</li><li><code>UNHEALTHY</code> status requires immediate attention</li><li>Multiple agents in <code>UNHEALTHY</code> state may indicate system-wide issues</li></ul><h3 id=resource-management>Resource Management</h3><ul><li>Implement resource limits in containers</li><li>Monitor resource trends over time</li><li>Scale resources based on historical usage patterns</li></ul><h2 id=troubleshooting>Troubleshooting</h2><h3 id=common-issues>Common Issues</h3><h4 id=high-cpu-usage>High CPU Usage</h4><ul><li>Check for infinite loops or inefficient algorithms</li><li>Look for thread contention</li><li>Examine GC activity</li></ul><h4 id=memory-leaks>Memory Leaks</h4><ul><li>Monitor heap usage over time</li><li>Check for objects that aren&rsquo;t being garbage collected</li><li>Use memory profiling tools if needed</li></ul><h4 id=agent-communication-issues>Agent Communication Issues</h4><ul><li>Check NATS connection status</li><li>Verify agent registration</li><li>Look for timeout errors in logs</li></ul><h4 id=circuit-breaker-activation>Circuit Breaker Activation</h4><ul><li>Check logs for &ldquo;Circuit breaker opened&rdquo; messages</li><li>Investigate root cause of failures</li><li>Allow time for automatic reset or manually reset if necessary</li></ul><h2 id=future-enhancements>Future Enhancements</h2><p>Planned enhancements for the health monitoring system:</p><ol><li><strong>Web Dashboard</strong>: A real-time web UI for system health visualization</li><li><strong>Prometheus Integration</strong>: Export metrics to Prometheus for advanced monitoring</li><li><strong>Alerting System</strong>: Configurable alerts for critical health issues</li><li><strong>Historical Data</strong>: Long-term storage and analysis of health metrics</li><li><strong>Predictive Analytics</strong>: Machine learning models to predict potential issues</li></ol><h2 id=references>References</h2><ul><li><a href=https://docs.oracle.com/en/java/javase/17/management/monitoring-and-management-using-jmx-technology.html>Metrics Collection in JVM</a></li><li><a href=https://martinfowler.com/bliki/CircuitBreaker.html>Circuit Breaker Pattern</a></li><li><a href=https://docs.nats.io/nats-concepts/core-nats/reqreply>NATS Request-Reply</a></li><li><a href=https://microservices.io/patterns/observability/health-check-api.html>Health Check API Best Practices</a></li></ul></div><div class=related-docs><h2>Related Documents</h2><ul><li><a href=/docs/guides/testing-guide.md>/docs/guides/testing-guide.md</a></li><li><a href=/docs/guides/containerized-dev-environment.md>/docs/guides/containerized-dev-environment.md</a></li><li><a href=/docs/project/build-engineer-next-steps.md>/docs/project/build-engineer-next-steps.md</a></li></ul></div><div class=tags><h3>Tags</h3><ul><li><a href=/tags/health>health</a></li><li><a href=/tags/monitoring>monitoring</a></li><li><a href=/tags/metrics>metrics</a></li><li><a href=/tags/resilience>resilience</a></li><li><a href=/tags/circuit-breaker>circuit-breaker</a></li></ul></div></article></main></div><footer class=footer><div class=container><p>&copy; 2025 ScopeCam MCP Documentation. All rights reserved.</p></div></footer></body></html>